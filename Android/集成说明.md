蓝牙扫描模块与过滤器集成 - 使用指南
==========================================

本集成实现了蓝牙设备扫描时的实时过滤功能。在扫描过程中，发现的设备会优先进行当前设置的所有过滤规则的过滤检查，只有通过过滤规则的设备才会被显示。

## 核心实现流程

```
用户开始扫描
  ↓
系统蓝牙模块发现设备
  ↓
bluetoothReceiver.onReceive() 捕获事件
  ↓
创建 BluetoothDeviceModel 对象
  ↓
调用 addDevice(device) 添加设备
  ↓
调用 applyFilters(device) 检查是否应过滤
  ↓
调用 filterDataSource.shouldFilterDevice(name, mac)
  ↓
根据白名单/黑名单规则判断
  ↓
返回 true（应过滤）或 false（允许）
  ↓
只有通过过滤的设备才被添加到 discoveredDevices 列表
  ↓
UI 订阅 discoveredDevices 并显示设备
```

## 修改的关键文件

### 1. BluetoothLocalDataSource (蓝牙扫描层)
- **新增参数**: `filterDataSource: BluetoothFilterLocalDataSource?`
- **新增方法**: `applyFilters(device)` - 在设备被添加前进行过滤检查
- **修改逻辑**: `addDevice()` 方法现在在添加设备前先调用 applyFilters()

### 2. BluetoothRepository (仓库层)
- **修改构造参数**: 新增 `filterRepository: BluetoothFilterRepository? = null`
- **目的**: 支持过滤器配置

### 3. BluetoothViewModel (ViewModel层)
- **初始化顺序**: 先创建 filterDataSource，再把它传递给 BluetoothLocalDataSource
- **集成方式**:
  ```kotlin
  val filterDataSource = BluetoothFilterLocalDataSource(context)
  val bluetoothLocalDataSource = BluetoothLocalDataSource(context, filterDataSource)
  val filterRepository = BluetoothFilterRepository(filterDataSource)
  val bluetoothRepository = BluetoothRepository(bluetoothLocalDataSource, filterRepository)
  ```

## 使用示例

### 示例1: 白名单 - 只允许iPhone设备

```kotlin
val filter = BluetoothFilterModel(
    id = "whitelist_iphone",
    alias = "允许iPhone设备",
    filterRule = "iPhone",
    matchType = BluetoothFilterModel.MatchType.DEVICE_NAME,
    enableRegex = false,
    filterType = BluetoothFilterModel.FilterType.WHITELIST,
    isEnabled = true,
    description = "只允许设备名包含'iPhone'的设备"
)

viewModel.addFilterRule(filter)
viewModel.startScan()
// 结果：只有设备名包含"iPhone"的设备会被显示
```

### 示例2: 黑名单 - 禁止特定MAC地址

```kotlin
val filter = BluetoothFilterModel(
    id = "blacklist_mac",
    alias = "禁止某设备",
    filterRule = "AA:BB:CC:DD:EE:FF",
    matchType = BluetoothFilterModel.MatchType.MAC_ADDRESS,
    enableRegex = false,
    filterType = BluetoothFilterModel.FilterType.BLACKLIST,
    isEnabled = true,
    description = "禁止MAC地址为AA:BB:CC:DD:EE:FF的设备"
)

viewModel.addFilterRule(filter)
viewModel.startScan()
// 结果：所有设备都会显示，除了MAC地址为"AA:BB:CC:DD:EE:FF"的设备
```

### 示例3: 正则表达式 - 匹配Apple所有产品

```kotlin
val filter = BluetoothFilterModel(
    id = "regex_apple",
    alias = "Apple设备",
    filterRule = "^(iPhone|iPad|Apple Watch).*",
    matchType = BluetoothFilterModel.MatchType.DEVICE_NAME,
    enableRegex = true,
    filterType = BluetoothFilterModel.FilterType.WHITELIST,
    isEnabled = true,
    description = "只允许Apple品牌的设备"
)

viewModel.addFilterRule(filter)
viewModel.startScan()
// 结果：只有iPhone、iPad、Apple Watch会被显示
```

## 过滤逻辑说明

### 白名单模式 (WHITELIST)
- 如果存在白名单规则，设备**必须**匹配至少一条白名单规则才会显示
- 不匹配任何白名单规则的设备会被过滤隐藏

### 黑名单模式 (BLACKLIST)
- 如果设备匹配任何黑名单规则，该设备会被过滤隐藏
- 不匹配黑名单的设备会显示

### 混合模式（同时有白名单和黑名单）
```
1. 优先检查白名单 → 如果有白名单规则，设备必须先匹配白名单
2. 然后检查黑名单 → 即使在白名单中，也不能同时在黑名单中
3. 最终结果 → 只显示"在白名单中且不在黑名单中"的设备
```

### 无规则或全禁用
- 如果没有任何启用的过滤规则，所有扫描到的设备都会显示

## 匹配类型说明

### DEVICE_NAME (设备名)
- 按蓝牙设备的名称进行过滤
- 支持简单的字符串包含匹配和正则表达式

### MAC_ADDRESS (MAC地址)
- 按蓝牙设备的MAC地址进行过滤
- MAC地址格式: XX:XX:XX:XX:XX:XX

## 测试

已创建综合测试文件: `BluetoothScanFilterIntegrationTest.kt`

测试覆盖的场景:
1. ✓ 没有过滤规则时，所有设备都会被显示
2. ✓ 白名单过滤 - 只允许匹配的设备
3. ✓ 黑名单过滤 - 阻止匹配的设备
4. ✓ 禁用规则不会被应用
5. ✓ 正则表达式过滤
6. ✓ 多个规则的综合应用
7. ✓ 规则启用/禁用切换

运行测试:
```bash
./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.powercess.blnav.data.datasource.local.BluetoothScanFilterIntegrationTest
```

## 实时动态过滤

在扫描过程中可以随时修改过滤规则，新规则会立即生效：

```kotlin
// 正在扫描时
viewModel.startScan()

// 添加新规则
viewModel.addFilterRule(newFilter)
// 之后发现的新设备会使用新规则进行过滤

// 更新规则
viewModel.updateFilterRule(existingFilter.copy(isEnabled = false))
// 规则被禁用，之前被过滤的设备可能会重新显示

// 删除规则
viewModel.deleteFilterRule(filterId)
// 规则被删除，之前被过滤的设备可能会重新显示
```

## 性能优化建议

1. **减少规则数量**: 每次发现设备都要进行规则检查，规则越多越耗时
2. **合理使用正则表达式**: 复杂的正则表达式会增加CPU占用，建议测试性能
3. **使用isEnabled标志**: 而不是删除规则，这样可以快速禁用/启用而不丢失配置
4. **优化规则顺序**: 考虑将最常匹配的规则放在前面

## 完整的高级设置界面集成

高级蓝牙设置界面 (`AdvancedBluetoothSettingsScreen.kt`) 已包含:
- ✓ 过滤规则列表显示
- ✓ 添加新规则
- ✓ 编辑现有规则
- ✓ 删除规则（含确认对话框）
- ✓ 启用/禁用规则（含确认对话框）
- ✓ 统计信息（总规则数、启用数、白名单数、黑名单数）

用户可以在高级蓝牙设置界面中配置所有的过滤规则。

## 注意事项

1. **出错处理**: 如果过滤规则检查过程中发生异常，出于安全考虑，设备会被允许显示（不会因过滤器出错导致设备被隐藏）

2. **SharedPreferences持久化**: 所有过滤规则都会自动保存到SharedPreferences，即使应用重启也不会丢失

3. **线程安全**: 在BroadcastReceiver中使用runBlocking{}来调用suspend函数，确保线程安全

4. **正则表达式验证**: 建议在UI中添加正则表达式验证，提前发现无效的正则表达式

5. **性能监控**: 如果扫描变慢，可以检查是否有过于复杂的正则表达式或过多的过滤规则

## 总结

通过这个集成，蓝牙扫描模块现在支持:
✓ 实时过滤 - 设备在被显示前就进行过滤检查
✓ 灵活配置 - 支持白名单、黑名单、正则表达式等多种方式
✓ 动态更新 - 扫描过程中可随时修改过滤规则
✓ 持久化存储 - 规则自动保存到本地
✓ 完整UI - 高级设置界面支持规则的增删改查

用户现在可以在高级蓝牙设置界面配置过滤规则，当启动扫描时，只有通过当前所有过滤规则的设备才会被显示。

